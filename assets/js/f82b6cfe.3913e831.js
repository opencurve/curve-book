"use strict";(self.webpackChunkcurve_book=self.webpackChunkcurve_book||[]).push([[9932],{3905:(e,t,n)=>{n.d(t,{Zo:()=>m,kt:()=>k});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function p(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var o=a.createContext({}),u=function(e){var t=a.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):p(p({},t),e)),n},m=function(e){var t=u(e.components);return a.createElement(o.Provider,{value:t},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},s=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,o=e.parentName,m=i(e,["components","mdxType","originalType","parentName"]),c=u(n),s=r,k=c["".concat(o,".").concat(s)]||c[s]||d[s]||l;return n?a.createElement(k,p(p({ref:t},m),{},{components:n})):a.createElement(k,p({ref:t},m))}));function k(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,p=new Array(l);p[0]=s;var i={};for(var o in t)hasOwnProperty.call(t,o)&&(i[o]=t[o]);i.originalType=e,i[c]="string"==typeof e?e:r,p[1]=i;for(var u=2;u<l;u++)p[u]=n[u];return a.createElement.apply(null,p)}return a.createElement.apply(null,n)}s.displayName="MDXCreateElement"},8683:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>p,default:()=>d,frontMatter:()=>l,metadata:()=>i,toc:()=>u});var a=n(7462),r=(n(7294),n(3905));const l={},p="CurveBS RDMA+SPDK \u7248\u672c\u90e8\u7f72",i={unversionedId:"CurveBS/deploy/rdma-spdk",id:"CurveBS/deploy/rdma-spdk",title:"CurveBS RDMA+SPDK \u7248\u672c\u90e8\u7f72",description:"\u7cfb\u7edf\u73af\u5883",source:"@site/docs/02-CurveBS/02-deploy/09-rdma-spdk.md",sourceDirName:"02-CurveBS/02-deploy",slug:"/CurveBS/deploy/rdma-spdk",permalink:"/CurveBS/deploy/rdma-spdk",draft:!1,tags:[],version:"current",sidebarPosition:9,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"OpenStack \u5bf9\u63a5",permalink:"/CurveBS/deploy/openstack"},next:{title:"CurveBS \u63a7\u5236\u53f0\u90e8\u7f72",permalink:"/CurveBS/deploy/dashboard"}},o={},u=[{value:"\u7cfb\u7edf\u73af\u5883",id:"\u7cfb\u7edf\u73af\u5883",level:2},{value:"\u914d\u7f6e",id:"\u914d\u7f6e",level:2},{value:"\u5f00\u542f IOMMU",id:"\u5f00\u542f-iommu",level:3},{value:"\u8c03\u6574 memlock \u9650\u5236",id:"\u8c03\u6574-memlock-\u9650\u5236",level:3},{value:"\u5b89\u88c5 OFED \u9a71\u52a8",id:"\u5b89\u88c5-ofed-\u9a71\u52a8",level:3},{value:"\u90e8\u7f72 Curve",id:"\u90e8\u7f72-curve",level:2},{value:"CurveAdm \u7248\u672c",id:"curveadm-\u7248\u672c",level:3},{value:"\u955c\u50cf",id:"\u955c\u50cf",level:3},{value:"\u683c\u5f0f\u5316\u78c1\u76d8",id:"\u683c\u5f0f\u5316\u78c1\u76d8",level:3},{value:"\u96c6\u7fa4\u62d3\u6251\u6587\u4ef6",id:"\u96c6\u7fa4\u62d3\u6251\u6587\u4ef6",level:3},{value:"\u90e8\u7f72\u96c6\u7fa4",id:"\u90e8\u7f72\u96c6\u7fa4",level:3},{value:"\u67e5\u770b\u96c6\u7fa4\u72b6\u6001",id:"\u67e5\u770b\u96c6\u7fa4\u72b6\u6001",level:3},{value:"\u6302\u8f7d NBD \u76d8",id:"\u6302\u8f7d-nbd-\u76d8",level:3},{value:"\u5176\u4ed6",id:"\u5176\u4ed6",level:2},{value:"\u6027\u80fd\u6d4b\u8bd5",id:"\u6027\u80fd\u6d4b\u8bd5",level:3},{value:"\u4f7f\u7528 fio cbd \u5f15\u64ce\u6d4b\u8bd5",id:"\u4f7f\u7528-fio-cbd-\u5f15\u64ce\u6d4b\u8bd5",level:3},{value:"\u91cd\u65b0\u90e8\u7f72\u6216\u683c\u5f0f\u5316\u6b65\u9aa4",id:"\u91cd\u65b0\u90e8\u7f72\u6216\u683c\u5f0f\u5316\u6b65\u9aa4",level:3},{value:"\u5b58\u50a8\u8282\u70b9\u91cd\u542f",id:"\u5b58\u50a8\u8282\u70b9\u91cd\u542f",level:3},{value:"\u53c2\u8003",id:"\u53c2\u8003",level:2}],m={toc:u},c="wrapper";function d(e){let{components:t,...l}=e;return(0,r.kt)(c,(0,a.Z)({},m,l,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"curvebs-rdmaspdk-\u7248\u672c\u90e8\u7f72"},"CurveBS RDMA+SPDK \u7248\u672c\u90e8\u7f72"),(0,r.kt)("h2",{id:"\u7cfb\u7edf\u73af\u5883"},"\u7cfb\u7edf\u73af\u5883"),(0,r.kt)("p",null,"\u81f3\u5c11 3 \u53f0\u673a\u5668\u4f5c\u4e3a\u5b58\u50a8\u8282\u70b9\uff0c\u76f8\u5173\u914d\u7f6e\u53c2\u8003\u5982\u4e0b"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"CentOS 7.9"),(0,r.kt)("li",{parentName:"ul"},"Linux 5.4.247-1.el7.elrepo.x86_64 x86_64"),(0,r.kt)("li",{parentName:"ul"},"Mellanox CX4/CX5 \u7f51\u5361\uff0c\u4ea4\u6362\u673a\u9700\u8981\u652f\u6301\u8bbe\u7f6e ECN"),(0,r.kt)("li",{parentName:"ul"},"NVMe \u76d8\uff08\u6bcf\u4e2a\u76d8\u81f3\u5c11\u5360\u7528 2 \u4e2a CPU\uff09")),(0,r.kt)("p",null,"\u81f3\u5c11 1 \u53f0\u673a\u5668\u4f5c\u4e3a\u5ba2\u6237\u7aef\u8282\u70b9\uff0c\u76f8\u5173\u914d\u7f6e\u53c2\u8003\u5982\u4e0b"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"CentOS 7.9"),(0,r.kt)("li",{parentName:"ul"},"Linux 5.4.247-1.el7.elrepo.x86_64 x86_64"),(0,r.kt)("li",{parentName:"ul"},"Mellanox CX4/CX5 \u7f51\u5361\uff0c\u4ea4\u6362\u673a\u9700\u8981\u652f\u6301\u8bbe\u7f6e ECN")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"TIPS:"),(0,r.kt)("ul",{parentName:"blockquote"},(0,r.kt)("li",{parentName:"ul"},"Debian 11 \u73af\u5883\u540c\u6837\u652f\u6301\uff0cMLNX-OFED \u9a71\u52a8\u5b89\u88c5\u53c2\u8003 ",(0,r.kt)("a",{parentName:"li",href:"https://docs.nvidia.com/networking/display/MLNXOFEDv582030LTS/Installation"},"Installation")),(0,r.kt)("li",{parentName:"ul"},"\u5982\u679c\u6ca1\u6709\u5355\u72ec\u7684\u5ba2\u6237\u7aef\u8282\u70b9\uff0c\u53ef\u4ee5\u590d\u7528\u5b58\u50a8\u8282\u70b9\uff0c\u4f46\u5bf9\u6027\u80fd\u6d4b\u8bd5\u53ef\u80fd\u7565\u6709\u5f71\u54cd"))),(0,r.kt)("h2",{id:"\u914d\u7f6e"},"\u914d\u7f6e"),(0,r.kt)("h3",{id:"\u5f00\u542f-iommu"},"\u5f00\u542f IOMMU"),(0,r.kt)("p",null,"\u4fee\u6539 /etc/default/grub\uff0c\u5728 GRUB_COMMAND_LINE \u6700\u540e\u52a0\u5165 ",(0,r.kt)("inlineCode",{parentName:"p"},"intel_iommu=on"),"\uff0c\u6839\u636e BIOS \u6a21\u5f0f\u66f4\u65b0\u4e0d\u540c\u7684 grub.cfg \u6587\u4ef6"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'$ test -d /sys/firmware/efi && echo "UEFI" || echo "Legacy"\n\n# Legacy \u6a21\u5f0f\n$ grub2-mkconfig -o /boot/grub2/grub.cfg\n\n# UEFI \u6a21\u5f0f\n$ grub2-mkconfig -o /boot/efi/EFI/centos/grub.cfg\n')),(0,r.kt)("p",null,"\u7136\u540e\u91cd\u542f\u673a\u5668\u3002"),(0,r.kt)("h3",{id:"\u8c03\u6574-memlock-\u9650\u5236"},"\u8c03\u6574 memlock \u9650\u5236"),(0,r.kt)("p",null,"SPDK \u548c UCX \u90fd\u4f1a\u4f9d\u8d56 memlcok\uff0c\u9700\u8981\u8fdb\u884c\u8c03\u6574\uff0c\u5728 /etc/security/limits.conf \u6587\u4ef6\u4e2d\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"*     hard   memlock           unlimited\n*     soft   memlock           unlimited\n")),(0,r.kt)("h3",{id:"\u5b89\u88c5-ofed-\u9a71\u52a8"},"\u5b89\u88c5 OFED \u9a71\u52a8"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"OFED \u9a71\u52a8\u9700\u8981\u7f16\u8bd1\u5b89\u88c5\uff0c\u9ed8\u8ba4 GCC4.8.5 \u4f1a\u51fa\u73b0\u7f16\u8bd1\u62a5\u9519\uff0c\u901a\u8fc7 devtoolset \u5b89\u88c5 GCC10"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ yum install centos-release-scl -y\n$ yum install devtoolset-10 -y\n$ scl enable devtoolset-10 bash\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"\u5b89\u88c5\u4f9d\u8d56\u5305"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ yum install libibverbs-utils perftest createrepo tcl gcc-gfortran fuse-libs tk\n$ yum --enablerepo=elrepo-kernel install -y kernel-lt-devel.x86_64   # kernel-devel\u7684\u7248\u672c\u8981\u8ddf\u5b9e\u9645\u7684\u5185\u6838\u7248\u672c\u4fdd\u6301\u4e00\u81f4\uff0c\u5982\u679c\u5df2\u7ecf\u5b89\u88c5\u53ef\u4ee5\u7701\u7565\uff08\u8be5\u547d\u4ee4\u8ddf\u5185\u6838\u7248\u672c\u6709\u5173\uff0c\u5b9e\u9645\u547d\u4ee4\u53ef\u80fd\u6709\u6240\u4e0d\u540c\uff09\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"\u5b89\u88c5 OFED \u9a71\u52a8"),(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"\u4e0b\u8f7d\u5305 ",(0,r.kt)("a",{parentName:"p",href:"https://www.mellanox.com/page/mlnx_ofed_eula?mtag=linux_sw_drivers&mrequest=downloads&mtype=ofed&mver=MLNX_OFED-5.8-2.0.3.0&mname=MLNX_OFED_LINUX-5.8-2.0.3.0-rhel7.9-x86_64.tgz"},"https://www.mellanox.com/page/mlnx_ofed_eula?mtag=linux_sw_drivers&mrequest=downloads&mtype=ofed&mver=MLNX_OFED-5.8-2.0.3.0&mname=MLNX_OFED_LINUX-5.8-2.0.3.0-rhel7.9-x86_64.tgz"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"\u89e3\u538b\u540e\u6267\u884c ",(0,r.kt)("inlineCode",{parentName:"p"},"./mlnxofedinstall --add-kernel-support")),(0,r.kt)("p",{parentName:"li"},"\u8fd9\u4e2a\u8fc7\u7a0b\u4f1a\u4e0b\u8f7d\u4e00\u4e9b\u5305\u548c\u4f9d\u8d56\uff0c\u5e76\u4e14\u7f16\u8bd1\u5b89\u88c5\uff0c\u4e2d\u9014\u53ef\u80fd\u4f1a\u62a5\u9519\uff0c\u6839\u636e\u62a5\u9519\u5b89\u88c5\u76f8\u5e94\u7684\u5305\u3002")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"\u5b8c\u6210\u540e\u6267\u884c\u5982\u4e0b\u547d\u4ee4"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ dract -f\n$ /etc/init.d/openibd restart\n$ reboot   # \u91cd\u542f\u673a\u5668\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"\u9a8c\u8bc1\u7f51\u7edc"),(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"IB \u6d4b\u8bd5"),(0,r.kt)("p",{parentName:"li"},"\u670d\u52a1\u7aef\u547d\u4ee4 ",(0,r.kt)("inlineCode",{parentName:"p"},"ib_write_bw -F -d mlx5_bond_0 -q 1 --report_gbits -D 60 --cpu_util")),(0,r.kt)("p",{parentName:"li"},"\u5ba2\u6237\u7aef\u547d\u4ee4 ",(0,r.kt)("inlineCode",{parentName:"p"},"ib_write_bw -F -d mlx5_bond_0 -q 1 --report_gbits -D 60 --cpu_util <Server IP Address>")),(0,r.kt)("p",{parentName:"li"},"\u547d\u4ee4\u4e2d -d \u540e\u9762\u7684\u53c2\u6570\u9700\u8981\u66ff\u6362\u4e3a ",(0,r.kt)("inlineCode",{parentName:"p"},"ibv_devinfo")," \u547d\u4ee4\u8f93\u51fa\u4e2d\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"hca_id")),(0,r.kt)("p",{parentName:"li"},"\u6d4b\u8bd5\u8f93\u51fa\u7ed3\u679c\u793a\u4f8b\uff08\u670d\u52a1\u7aef\uff09\uff1a"),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{alt:"ib-server",src:n(5979).Z,width:"1798",height:"1018"})),(0,r.kt)("p",{parentName:"li"},"\u6d4b\u8bd5\u8f93\u51fa\u7ed3\u679c\u793a\u4f8b\uff08\u5ba2\u6237\u7aef\uff09\uff1a"),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{alt:"ib-client",src:n(8162).Z,width:"2030",height:"912"}))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"\u6267\u884c ",(0,r.kt)("inlineCode",{parentName:"p"},'ucx_info -d | grep "Trans"'),"\uff0c\u8f93\u51fa\u4e2d\u9700\u8981\u5305\u542b rc_mlx5/ud_mlx5 \u6216\u8005 rc_verbs/uc_verbs")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"\u4fdd\u5b58\u5982\u4e0b\u914d\u7f6e\u5230 ${HOME}/ucx.conf"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"[global]\nUCX_TLS=ib\nUCX_USE_MT_MUTEX=y\nUCX_RNDV_THRESH=32K\nUCX_TCP_CM_REUSEADDR=y\nUCX_RDMA_CM_REUSEADDR=y\nUCX_ASYNC_MAX_EVENTS=10000\nUCX_RC_VERBS_MAX_NUM_EPS=10000\nUCX_RC_MLX5_MAX_NUM_EPS=10000\nUCX_RCACHE_STAT_MAX=10M\n\nUCX_NET_DEVICES=mlx5_bond_0:1\n#UCX_IB_GID_INDEX=3\nUCX_RC_MLX5_TRAFFIC_CLASS=96\nUCX_RC_VERBS_TRAFFIC_CLASS=96\n\nUCX_RC_VERBS_TX_QUEUE_LEN=512\nUCX_RC_MLX5_TX_QUEUE_LEN=512\nUCX_TCP_MAX_IOV=128\nUCX_LOG_LEVEL=WARN\n#UCX_MAX_RNDV_RAILS=2\n#UCX_MAX_EAGER_RAILS=2\n")),(0,r.kt)("p",{parentName:"li"},"\u5176\u4e2d\uff0cUCX_NET_DEVICES \u8fd8\u662f\u9700\u8981\u7528 ",(0,r.kt)("inlineCode",{parentName:"p"},"ibv_devinfo")," \u7684\u8f93\u51fa\u66ff\u6362\uff0c\u5206\u522b\u4e3a ",(0,r.kt)("inlineCode",{parentName:"p"},"hca_id")," \u548c ",(0,r.kt)("inlineCode",{parentName:"p"},"port"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"ucx_perftest \u6d4b\u8bd5"),(0,r.kt)("p",{parentName:"li"},"\u670d\u52a1\u7aef\u547d\u4ee4 ",(0,r.kt)("inlineCode",{parentName:"p"},"ucx_perftest -c 0")),(0,r.kt)("p",{parentName:"li"},"\u5ba2\u6237\u7aef\u547d\u4ee4 ",(0,r.kt)("inlineCode",{parentName:"p"},"ucx_perftest <Server IP Address> -t ucp_am_bw -c 0 -s 65536")),(0,r.kt)("p",{parentName:"li"},"\u6d4b\u8bd5\u8f93\u51fa\u7ed3\u679c\u793a\u4f8b\uff08\u670d\u52a1\u7aef\uff09\uff1a"),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{alt:"ucx-perf-server",src:n(6176).Z,width:"1736",height:"436"})),(0,r.kt)("p",{parentName:"li"},"\u6d4b\u8bd5\u8f93\u51fa\u7ed3\u679c\u793a\u4f8b\uff08\u5ba2\u6237\u7aef\uff09\uff1a"),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{alt:"ucx-perf-client",src:n(4458).Z,width:"1740",height:"1050"})))))))),(0,r.kt)("h2",{id:"\u90e8\u7f72-curve"},"\u90e8\u7f72 Curve"),(0,r.kt)("p",null,"\u53c2\u8003 CurveAdm \u90e8\u7f72\u6587\u6863 ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/opencurve/curveadm/wiki/curvebs-cluster-deployment"},"\u670d\u52a1\u7aef")," ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/opencurve/curveadm/wiki/curvebs-client-deployment"},"\u5ba2\u6237\u7aef"),"\uff0c",(0,r.kt)("strong",{parentName:"p"},"\u8bf7\u63d0\u524d\u719f\u6089\u76f8\u5e94\u7684\u64cd\u4f5c\u548c\u6d41\u7a0b"),"\uff0c\u7279\u6b8a\u6b65\u9aa4\u6216\u914d\u7f6e\u5728\u4e0b\u9762\u5907\u6ce8\u3002"),(0,r.kt)("h3",{id:"curveadm-\u7248\u672c"},"CurveAdm \u7248\u672c"),(0,r.kt)("p",null,"\u66f4\u65b0\u5230\u6307\u5b9a\u7248\u672c ",(0,r.kt)("inlineCode",{parentName:"p"},"CURVEADM_VERSION=vrdma-rc2 curveadm -u")),(0,r.kt)("h3",{id:"\u955c\u50cf"},"\u955c\u50cf"),(0,r.kt)("p",null,"opencurvedocker/curvebs_rdma_spdk:1.2-netease\uff0c",(0,r.kt)("strong",{parentName:"p"},"\u683c\u5f0f\u5316\u548c\u90e8\u7f72\uff0c\u90fd\u4f7f\u7528\u8fd9\u4e2a\u955c\u50cf")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"TIPS: \u7531\u4e8e\u955c\u50cf\u8f83\u5927\uff0c\u9700\u63d0\u524d\u5728\u5b58\u50a8\u8282\u70b9\u548c\u5ba2\u6237\u7aef\u8282\u70b9\u4e0a\u628a\u955c\u50cf\u62c9\u4e0b\u6765 ",(0,r.kt)("inlineCode",{parentName:"p"},"docker pull opencurvedocker/curvebs_rdma_spdk:1.2-netease"))),(0,r.kt)("h3",{id:"\u683c\u5f0f\u5316\u78c1\u76d8"},"\u683c\u5f0f\u5316\u78c1\u76d8"),(0,r.kt)("p",null,"\u7531\u4e8e SPDK \u7248\u672c\u7684\u9650\u5236\uff0c\u76ee\u524d\u683c\u5f0f\u5316\u6bd4\u4f8b\u6700\u9ad8\u53ea\u80fd\u8bbe\u7f6e\u5230 75%\uff08\u7b2c\u4e00\u6b21\u90e8\u7f72\u53ef\u4ee5\u5148\u683c\u5f0f\u5316 10% \u6216\u8005 20%\uff0c\u786e\u8ba4\u662f\u5426\u80fd\u6b63\u5e38\u90e8\u7f72\u96c6\u7fa4\uff09"),(0,r.kt)("p",null,"\u683c\u5f0f\u5316\u547d\u4ee4\uff1a",(0,r.kt)("inlineCode",{parentName:"p"},"curveadm format --spdk -f format.yaml")," \uff0c\u6ce8\u610f\u5176\u4e2d\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"\u2014-spdk")," \u53c2\u6570"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"TIPS:"),(0,r.kt)("ul",{parentName:"blockquote"},(0,r.kt)("li",{parentName:"ul"},"SPDK \u683c\u5f0f\u5316\u7684\u8fc7\u7a0b\u4f1a\u7ed1\u5b9a NVMe \u5230 VFIO \u9a71\u52a8\uff0c\u5bfc\u81f4 lsblk \u65e0\u6cd5\u770b\u5230 NVMe \u76d8"),(0,r.kt)("li",{parentName:"ul"},"SPDK \u683c\u5f0f\u5316\u6682\u65f6\u4e0d\u652f\u6301\u67e5\u770b\u8fdb\u5ea6\uff0c\u9700\u8981\u5230\u5b58\u50a8\u8282\u70b9\u4e0a\u67e5\u770b\u683c\u5f0f\u5316\u8fdb\u7a0b\u662f\u5426\u9000\u51fa ",(0,r.kt)("inlineCode",{parentName:"li"},"ps aux | grep format"),"\uff08\u6216\u683c\u5f0f\u5316\u7684\u5bb9\u5668\u662f\u5426\u9000\u51fa\uff09"))),(0,r.kt)("h3",{id:"\u96c6\u7fa4\u62d3\u6251\u6587\u4ef6"},"\u96c6\u7fa4\u62d3\u6251\u6587\u4ef6"),(0,r.kt)("p",null,"\u5728 chunkserver services \u4e2d\u6dfb\u52a0\u5982\u4e0b\u5b57\u6bb5"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"chunkserver_services:\n  config:\n    listen.ucp_port: 92${format_replicas_sequence}  # 9200,9201,9202\n    use_ucp: true\n    use_spdk: true\n")),(0,r.kt)("h3",{id:"\u90e8\u7f72\u96c6\u7fa4"},"\u90e8\u7f72\u96c6\u7fa4"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"\u628a\u914d\u7f6e\u8fc7\u7a0b\u4e2d\u4f7f\u7528\u5230\u7684 ucx.conf \u6587\u4ef6\u590d\u5236\u5230\u5f53\u524d\u76ee\u5f55\uff08\u6267\u884c curveadm \u547d\u4ee4\u7684\u76ee\u5f55\uff09")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"curveadm deploy -k"),"\uff0c\u5982\u679c\u4e0d\u9700\u8981\u5feb\u7167\u514b\u9686\u670d\u52a1\u53ef\u4ee5\u52a0\u4e0a ",(0,r.kt)("inlineCode",{parentName:"p"},"--skip snapshotclone")))),(0,r.kt)("h3",{id:"\u67e5\u770b\u96c6\u7fa4\u72b6\u6001"},"\u67e5\u770b\u96c6\u7fa4\u72b6\u6001"),(0,r.kt)("p",null,"\u8fdb\u5165\u5176\u4e2d\u4e00\u4e2a MDS \u5bb9\u5668\uff0c",(0,r.kt)("inlineCode",{parentName:"p"},"curveadm enter ${Id}"),"\uff0c\u7136\u540e\u6267\u884c ",(0,r.kt)("inlineCode",{parentName:"p"},"curve_ops_tool copysets-status")),(0,r.kt)("p",null,"\u5982\u4e0b\u8f93\u51fa\u8868\u793a\u6b63\u5e38"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"Copysets are healthy!\ntotal copysets: 400, unhealthy copysets: 0, unhealthy_ratio: 0%\n")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"TIPS: \u5982\u679c\u6ca1\u6709\u90e8\u7f72\u5feb\u7167\u514b\u9686\u670d\u52a1\uff0c\u547d\u4ee4\u6709\u53ef\u80fd\u4f1a\u62a5\u9519\uff0c\u9700\u8981\u4fee\u6539\u5bb9\u5668\u5185\u7684 /etc/curve/tools.conf \u914d\u7f6e\u6587\u4ef6"),(0,r.kt)("p",{parentName:"blockquote"},"\u4fee\u6539\u5982\u4e0b\u4e24\u4e2a\u914d\u7f6e\u9879\uff1a"),(0,r.kt)("p",{parentName:"blockquote"},"  snapshotCloneAddr=127.0.0.1:5555"),(0,r.kt)("p",{parentName:"blockquote"},"  snapshotCloneDummyPort=5556")),(0,r.kt)("h3",{id:"\u6302\u8f7d-nbd-\u76d8"},"\u6302\u8f7d NBD \u76d8"),(0,r.kt)("p",null,"\u53c2\u8003\u5ba2\u6237\u7aef\u90e8\u7f72\u6587\u6863\uff0c\u540c\u6837\u9700\u8981\u628a ucx.conf \u653e\u5230\u5f53\u524d\u76ee\u5f55"),(0,r.kt)("p",null,"\u6302\u8f7d\u6210\u529f\u540e\uff0c\u767b\u5f55\u5230\u5ba2\u6237\u7aef\u673a\u5668\u4e0a\uff0clsblk \u53ef\u4ee5\u770b\u5230\u5bf9\u5e94\u7684 nbd \u8bbe\u5907\uff0c\u53ef\u4ee5\u6267\u884c fio \u6d4b\u8bd5\uff0c\u53c2\u8003\u547d\u4ee4"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"fio -name=/dev/nbd0 -direct=1 -iodepth=128 -rw=randwrite -ioengine=libaio -bs=4k -size=10G -numjobs=1 -time_based -runtime=120\n")),(0,r.kt)("h2",{id:"\u5176\u4ed6"},"\u5176\u4ed6"),(0,r.kt)("h3",{id:"\u6027\u80fd\u6d4b\u8bd5"},"\u6027\u80fd\u6d4b\u8bd5"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u81f3\u5c11\u9700\u8981 100G \u7684\u5377\u624d\u80fd\u6d4b\u8bd5\u51fa\u6bd4\u8f83\u771f\u5b9e\u7684\u6027\u80fd")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u5927 IO \u987a\u5e8f\u8bfb\u5199\u6d4b\u8bd5\u9700\u8981\u521b\u5efa\u6761\u5e26\u5377\uff0ccurveadm map \u4e0d\u652f\u6301\u521b\u5efa\u6761\u5e26\u5377\uff0c\u9700\u8981\u5230\u5176\u4e2d\u4e00\u4e2a MDS \u5bb9\u5668\u4e2d\u6267\u884c\u547d\u4ee4\u521b\u5efa"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u53c2\u8003\u547d\u4ee4 ",(0,r.kt)("inlineCode",{parentName:"p"},"curve_ops_tool create -fileName=/test -userName=curve -fileLength=200 -stripeUnit=32768 -stripeCount=32"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"curveadm map \u547d\u4ee4\u53bb\u6389\u81ea\u52a8\u521b\u5efa\u5377\u7684\u53c2\u6570")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u5728\u5927 IO \u8bfb\u7684\u6d4b\u8bd5\u4e2d\uff0c\u53ef\u80fd\u4f1a\u51fa\u73b0\u6027\u80fd\u5f88\u4f4e\u6216\u6296\u52a8\u660e\u663e\u7684\u60c5\u51b5\uff0c\u8fd9\u79cd\u60c5\u51b5\u9700\u8981\u5728\u7269\u7406\u673a\u548c\u4ea4\u6362\u673a\u4e0a\u8fdb\u884c RDMA \u62e5\u585e\u63a7\u5236\u8c03\u6574\uff08\u5177\u4f53\u6b65\u9aa4\u7565\u5fae\u7e41\u7410\uff0c\u8fd9\u91cc\u4e0d\u5c55\u5f00\uff09"))))),(0,r.kt)("h3",{id:"\u4f7f\u7528-fio-cbd-\u5f15\u64ce\u6d4b\u8bd5"},"\u4f7f\u7528 fio cbd \u5f15\u64ce\u6d4b\u8bd5"),(0,r.kt)("p",null,"cbd \u5f15\u64ce\u6d4b\u8bd5\u53ef\u4ee5\u907f\u514d nbd \u6302\u8f7d\u5e26\u6765\u7684\u989d\u5916\u5f00\u9500\uff0c\u5728\u5355\u5377\u6d4b\u8bd5\u4e2d\uff0c\u4f1a\u6709\u66f4\u9ad8\u7684\u6027\u80fd\u3002"),(0,r.kt)("p",null,"\u4e3a\u4e86\u65b9\u4fbf\u7f16\u8bd1\uff0c\u5982\u4e0b\u547d\u4ee4\u4ee5\u5728 curveadm map \u521b\u5efa\u7684\u5bb9\u5668\u5185\u6267\u884c"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u8fdb\u5165\u5bb9\u5668")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'$ curveadm client status\nGet Client Status: [OK]\n\nId            Kind     Host    Container Id  Status     Aux Info\n--            ----     ----    ------------  ------     --------\n5f1c10fd4d71  curvebs  curve1  dcbb6b69028e  Up 9 days  {"user":"test","volume":"/curve"}\n\n$ curveadm client enter 5f1c10fd4d71  # \u66ff\u6362\u4e3a\u4e0a\u9762\u8f93\u51fa\u7684\u5b9e\u9645Id\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u5728\u5bb9\u5668\u5185\u7f16\u8bd1\u5e76\u6267\u884c fio \u6d4b\u8bd5")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ git clone https://github.com/opencurve/fio.git -b curve\n$ cd fio\n$ ./configure   # \u8f93\u51fa\u4e2d\uff0ccbd engine \u9700\u8981\u662f yes\n$ make -j`nproc`\n\n# \u4fdd\u5b58\u5982\u4e0b\u6587\u4ef6\u5230 cbd.fio\n[global]\nioengine=cbd\ndirect=1\nbs=4k\niodepth=128\nrw=randwrite\nnumjobs=1\nsize=100G\nruntime=120\ntime_based\n\n[filename1]\ncbd=/test_curve_  # /test \u4e3a\u5377\u540d\uff0ccurve \u4e3a\u7528\u6237\u540d\n\n$ mkdir -p /curvebs/client/logs\n$ ./fio cbd.fio    # \u6267\u884c\u6d4b\u8bd5\n")),(0,r.kt)("h3",{id:"\u91cd\u65b0\u90e8\u7f72\u6216\u683c\u5f0f\u5316\u6b65\u9aa4"},"\u91cd\u65b0\u90e8\u7f72\u6216\u683c\u5f0f\u5316\u6b65\u9aa4"),(0,r.kt)("p",null,"\u7531\u4e8e\u7248\u672c\u9650\u5236\uff0c",(0,r.kt)("inlineCode",{parentName:"p"},"curveadm clean")," \u547d\u4ee4\u4e0d\u80fd\u56de\u6536 chunk \u5230 chunkfilepool \u4e2d\uff0c\u91cd\u65b0\u90e8\u7f72\u9700\u8981\u91cd\u65b0\u683c\u5f0f\u5316"),(0,r.kt)("p",null,"\u91cd\u65b0\u683c\u5f0f\u5316\u524d\uff0c\u9700\u8981\u89e3\u9664 NVMe \u7ed1\u5b9a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ curveadm format -f format.test.yaml --spdk --reset\n")),(0,r.kt)("h3",{id:"\u5b58\u50a8\u8282\u70b9\u91cd\u542f"},"\u5b58\u50a8\u8282\u70b9\u91cd\u542f"),(0,r.kt)("p",null,"\u5b58\u50a8\u8282\u70b9\u7684 NVMe \u76d8\u5728\u91cd\u542f\u540e\u6ca1\u6709\u81ea\u52a8\u7ed1\u5b9a\uff0c\u9700\u8981\u624b\u52a8\u7ed1\u5b9a\uff0c\u7136\u540e\u62c9\u8d77 Chunkserver"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ curveadm format -f format.yaml --spdk --only-binding\n$ curveadm start --role=chunkserver\n")),(0,r.kt)("h2",{id:"\u53c2\u8003"},"\u53c2\u8003"),(0,r.kt)("p",null,"[1][SPDK System Configuration User Guide]","(",(0,r.kt)("a",{parentName:"p",href:"https://spdk.io/doc/system_configuration.html"},"https://spdk.io/doc/system_configuration.html"),")"),(0,r.kt)("p",null,"[2][MLNX-OFED Installation]","(",(0,r.kt)("a",{parentName:"p",href:"https://docs.nvidia.com/networking/display/MLNXOFEDv582030LTS/Installation"},"https://docs.nvidia.com/networking/display/MLNXOFEDv582030LTS/Installation"),")"))}d.isMDXComponent=!0},8162:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/rdma-ib-client-1817460aa1b84bee61704d7b215dda49.png"},5979:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/rdma-ib-server-c724134556d1cbe142181e11d74c5c2c.png"},4458:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/rdma-ucx-perf-client-337045b4b8786a3e30ee466655760a3a.png"},6176:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/rdma-ucx-perf-server-7ef4d7180d0ccdf448182ee214764400.png"}}]);