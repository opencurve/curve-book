<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-CurveBS/architecture/chunkserver-arch">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">CurveBS Chunkserver 架构介绍 | Curve Book</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://docs.opencurve.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://docs.opencurve.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://docs.opencurve.io/CurveBS/architecture/chunkserver-arch"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="CurveBS Chunkserver 架构介绍 | Curve Book"><meta data-rh="true" name="description" content="1 ChunkServer 概述"><meta data-rh="true" property="og:description" content="1 ChunkServer 概述"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.opencurve.io/CurveBS/architecture/chunkserver-arch"><link data-rh="true" rel="alternate" href="https://docs.opencurve.io/CurveBS/architecture/chunkserver-arch" hreflang="zh"><link data-rh="true" rel="alternate" href="https://docs.opencurve.io/CurveBS/architecture/chunkserver-arch" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.ae228a11.css">
<link rel="preload" href="/assets/js/runtime~main.a19401bb.js" as="script">
<link rel="preload" href="/assets/js/main.3e776f2e.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="curve logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="curve logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Curve Book</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/opencurve/curve" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="搜索" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">关于 Curve</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/category/curve块存储">Curve块存储</a><button aria-label="打开/收起侧边栏菜单「Curve块存储」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/category/应用场景及案例">应用场景及案例</a><button aria-label="打开/收起侧边栏菜单「应用场景及案例」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/category/部署">部署</a><button aria-label="打开/收起侧边栏菜单「部署」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/category/测试">测试</a><button aria-label="打开/收起侧边栏菜单「测试」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/category/同类软件对比">同类软件对比</a><button aria-label="打开/收起侧边栏菜单「同类软件对比」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/category/架构">架构</a><button aria-label="打开/收起侧边栏菜单「架构」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/CurveBS/architecture/architecture-intro">架构介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/CurveBS/architecture/chunkserver-arch">CurveBS Chunkserver 架构介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/CurveBS/architecture/client-arch">CurveBS Client 架构介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/CurveBS/architecture/mds">CurveBS MDS 架构介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/CurveBS/architecture/snapshot">CurveBS 快照克隆架构设计</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/CurveBS/architecture/nebd">客户端热升级设计介绍</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/category/性能">性能</a><button aria-label="打开/收起侧边栏菜单「性能」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/category/运维">运维</a><button aria-label="打开/收起侧边栏菜单「运维」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/category/接口文档">接口文档</a><button aria-label="打开/收起侧边栏菜单「接口文档」" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/category/curve文件存储">Curve文件存储</a><button aria-label="打开/收起侧边栏菜单「Curve文件存储」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/category/开发者相关">开发者相关</a><button aria-label="打开/收起侧边栏菜单「开发者相关」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/category/社区相关">社区相关</a><button aria-label="打开/收起侧边栏菜单「社区相关」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/category/版本相关">版本相关</a><button aria-label="打开/收起侧边栏菜单「版本相关」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/faq">FAQ</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/category/roadmap">Roadmap</a><button aria-label="打开/收起侧边栏菜单「Roadmap」" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/category/curve块存储"><span itemprop="name">Curve块存储</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/category/架构"><span itemprop="name">架构</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">CurveBS Chunkserver 架构介绍</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>CurveBS Chunkserver 架构介绍</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-chunkserver-概述">1 ChunkServer 概述<a href="#1-chunkserver-概述" class="hash-link" aria-label="1 ChunkServer 概述的直接链接" title="1 ChunkServer 概述的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-设计背景">1.1 设计背景<a href="#11-设计背景" class="hash-link" aria-label="1.1 设计背景的直接链接" title="1.1 设计背景的直接链接">​</a></h3><p>Curve存储秉承设计为支持各种存储场景的统一的分布式存储系统的目标，以高性能块存储为第一优先级，并逐步支持在线/近线对象存储，文件存储，大数据等各类场景。Curve ChunkServer承担了Curve存储的I/O路径的服务者角色，需要为各类存储存储场景提供优化的服务能力，极力提供更高的I/O性能，存储效率，可用性和可靠性。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="12-系统概述">1.2 系统概述<a href="#12-系统概述" class="hash-link" aria-label="1.2 系统概述的直接链接" title="1.2 系统概述的直接链接">​</a></h3><p>Curve ChunkServer遵照类GFS的分布式存储架构设计，是数据节点，对外提供数据I/O(读，写，快照等)和节点管理功能(获取Chunkserver的状态，统计信息，修改各模块的运行时参数和状态等)的对外接口，底层基于ext4存储引擎，并进行抽象封装。ChunkServer跟Client和MetaServer交互，高效地执行Client I/O，响应MetaServer的空间分配和调度，数据迁移和恢复，I/O服务质量，状态查询和用户控制等各类请求，并维护数据的可靠性和副本一致性。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="13-设计目标">1.3 设计目标<a href="#13-设计目标" class="hash-link" aria-label="1.3 设计目标的直接链接" title="1.3 设计目标的直接链接">​</a></h3><p>作为支持统一存储场景特别是高性能分布式块存储产品I/O路径的服务提供者，ChunkServer需要在性能，可用性，可靠性，易维护性等多方面表现优秀，包括：</p><ul><li><p>高并发 	- 支持Client的高IOPS请求</p></li><li><p>低延时 	- Client I/O平均延时低，小于1ms</p></li><li><p>高容错 	- 在MDS的调度下，执行数据迁移和恢复, 并在此过程中保障I/O性能。容忍存储盘故障，保证集群数据存储整体的可靠性。</p></li><li><p>快照	- 支持Chunk级别的快照功能</p></li><li><p>热升级	- 可以针对集群进行在线升级，升级过程中ChunkServer集群可以继续不间断提供I/O服务</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-chunk-server系统设计">2 Chunk Server系统设计<a href="#2-chunk-server系统设计" class="hash-link" aria-label="2 Chunk Server系统设计的直接链接" title="2 Chunk Server系统设计的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-总体架构">2.1 总体架构<a href="#21-总体架构" class="hash-link" aria-label="2.1 总体架构的直接链接" title="2.1 总体架构的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="211-设计理念">2.1.1 设计理念<a href="#211-设计理念" class="hash-link" aria-label="2.1.1 设计理念的直接链接" title="2.1.1 设计理念的直接链接">​</a></h4><p>ChunkServer中用到了跟设计紧密相关的重要性理念，包括如下：</p><p>管理域 - ChunkServer的管理域为存储盘，每个数据服务器上有多块盘，每块盘对应一个ChunkServer实例，每个ChunkServer实例在OS上体现为一个用户态服务进程。不同的ChunkServer之间的隔离达到进程级别，单个ChunkServer的意外故障不会影响整台机器，单个存储盘不稳定或软件缺陷造成的性能问题也不会扩散到其他存储盘。</p><p>复制组(Copyset) - I/O数据块以复制组为处理单元进行副本复制和一致性处理，为了平衡故障恢复时间，负载均衡和故障隔离性，每块盘平均分布若干个复制组。每个复制组有一个主节点(Leader)和多个从节点(Follower)。Client端具有数据块对应的复制组信息，数据写发送到主节点，由主节点发送到从节点，收到从节点的响应后，主节点向Client返回操作结果。</p><p>异步I/O - ChunkServer从收到I/O请求开始到返回操作结果，路径上有网络数据收发，副本复制，事务写I/O等若干个相对耗时的处理逻辑。全同步的方式将造成这几个耗时的处理逻辑的串行化，通过异步化，增加整个链路的I/O并发性，可以对ChunkServer的处理能力大为提高。</p><p>线程池 - 由于每台数据服务器上存在大量的复制组数目和众多异步化I/O逻辑，I/O路径上需要大量的线程来进行并发处理，通过线程池来对这些线程进行生命周期管理，可以将具体逻辑从线程管理的负担中解放出来，同时复用线程生命周期，提供对服务器cpu架构更友好的亲和性，从而提高性能。</p><p>副本复制 - 多数副本同步复制，少数副本异步复制，避免少数慢盘影响性能</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="212-软件架构">2.1.2 软件架构<a href="#212-软件架构" class="hash-link" aria-label="2.1.2 软件架构的直接链接" title="2.1.2 软件架构的直接链接">​</a></h4><p>Chunk Server概要结构如下所示，通过网络消息收发层统一接收来自Client, MetaServer及其他ChunkServer的消息，不同类型的消息包括I/O请求，控制请求，以及事件通知，网络消息收发层通过RPC将不同的消息发送到服务层不同的子服务进行路由，子服务与Chunk Server中各个子系统相关联，包括I/O处理，快照，恢复，数据校验，配置，监控统计以及Chunk Server控制器等多个子系统，每个子服务包含一个接口集合，通过调用各个子系统中的不同功能提供服务。不同的子系统之间也可以通过对方的服务接口或内部接口进行相互协作。</p><p><img loading="lazy" alt="chunkserver arch" src="/assets/images/chunkserverstructure-be06634f40791416be3d5a693f15eb8e.png" width="1184" height="1102" class="img_ev3q"></p><p>各个功能子系统的功能和基本职责见下节功能子系统。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="213-功能子系统">2.1.3 功能子系统<a href="#213-功能子系统" class="hash-link" aria-label="2.1.3 功能子系统的直接链接" title="2.1.3 功能子系统的直接链接">​</a></h4><ul><li><p>RPC Service Layer</p><p>提供chunkserver对外的rpc服务处理逻辑，包含的rpc服务包括</p><ul><li><p>ChunkService</p><p>处理chunkserver I/O 相关服务，是chunkserver的核心服务，包含读chunk、写chunk（创建chunk在写时创建）、删除chunk、读chunk快照、删除chunk快照、获取chunk信息、创建克隆chunk等等I/O相关功能。</p></li><li><p>CliService</p><p>提供RAFT配置变更相关的rpc服务，包含AddPeer，RemovePeer，ChangePeer、GetLeader、ChangeLeader、ResetPeer等配置变更相关的服务。CliService底层通过调用Braft的配置变更相关接口完成配置变更。</p></li><li><p>CopySetService</p><p>调用CopySetNodeManager创建CopysetNode，即创建Raft节点。在chunkserver集群初始化时，通过MetaServer调用该接口在各ChunkServer上创建Raft节点，并启动Raft节点的相关服务。</p></li><li><p>RaftService</p><p>Braft的内置的RaftService，在chunkserver初始化时需要启动Raft对外的相关rpc服务。</p></li></ul></li><li><p>Internal Service Layer</p><ul><li><p>CopysetNodeManager</p><p>负责管理CopysetNode即RaftNode的创建和删除管理。</p></li><li><p>HeartBeat</p><p>心跳模块主要完成chunkserver对MetaServer定期上报心跳，使MetaServer感知chunkserver的存活性，感知chunkserver故障情况。同时心跳报文还负责上报chunkserver的各种状态、磁盘使用量等数据。</p></li><li><p>CloneManager</p><p>CloneManager主要负责克隆相关的功能，内部是一个线程池，主要负责异步完成克隆chunk的数据补全。关于克隆相关的内容请参考<a href="https://docs.opencurve.io/CurveBS/architecture/snapshot" target="_blank" rel="noopener noreferrer">克隆快照文档</a>。</p></li><li><p>CopysetNode</p><p>CopysetNode封装了Raft状态机，是chunkserver的核心结构。</p></li><li><p>ChunkOpRequest</p><p>ChunkOpRequest模块封装了对chunkservie到达的I/O请求的实际处理过程。</p></li><li><p>ChunkServerMetric</p><p>ChunkServerMetric是对chunkserver所有Metric的封装，负责采集chunkserver内部的各种metric，结合外部Prometheus和Graphna，方便的展示chunkserver内部的各项数据指标，方便观测和诊断chunkserver的各种问题。</p></li></ul></li><li><p>ConcurrentApplyModule</p><p>并发控制层，负责对chunkserver的IO请求进行并发控制，对上层的读写请求安照chunk粒度进行Hash，使得不同chunk的请求可以并发执行。</p></li><li><p>DataStore</p><p>DataStore是对chunk落盘逻辑的封装。包含chunkfile的创建、删除，以及实际对chunk的读写，chunk基本cow的快照，克隆chunk的管理等等。</p></li><li><p>LocalFileSystermAdaptor</p><p>LocalFileSystermAdaptor是对底层文件系统的一层抽象，目前适配封装了ext4文件系统的接口。
之所以要做这层抽象，目的是隔离了底层文件系统的实际读写请求，如果将来curve要适配裸盘或者采用其他文件系统，可以在这层进行适配。</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-关键模块">2.2 关键模块<a href="#22-关键模块" class="hash-link" aria-label="2.2 关键模块的直接链接" title="2.2 关键模块的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="221-chunkserver初始化">2.2.1 chunkserver初始化<a href="#221-chunkserver初始化" class="hash-link" aria-label="2.2.1 chunkserver初始化的直接链接" title="2.2.1 chunkserver初始化的直接链接">​</a></h4><h5 class="anchor anchorWithStickyNavbar_LWe7" id="chunkserver注册">chunkserver注册<a href="#chunkserver注册" class="hash-link" aria-label="chunkserver注册的直接链接" title="chunkserver注册的直接链接">​</a></h5><p>Chunkserver需要通过注册来加入一个Curve集群，并得到MDS分配的Chunkserver ID作为集群内的唯一合法标识，并需要在后续的通讯中提供此ID和token作为身份标记和合法性认证信息。</p><p>Chunkserver注册使用首次注册的模式。在首次启动时向MDS发送包含Chunkserver基本信息的注册消息，使MDS新增一条Chunkserver信息记录和调度对象，MDS向Chunkserver返回的消息中包含分配给此Chunkserver的ID作为此Chunkserver在集群中的唯一身份标志。后续Chunkserver启动或重启时，不再向MDS进行注册。</p><p>Chunkserver在启动时，流程如下：</p><ul><li><p>检测本地Chunkserver对应存储盘上的Chunkserver ID, 如果存在，说明注册过，直接跳过后续步骤；</p></li><li><p>构造ChunkServerRegistRequest消息，使用RegistChunkServer接口发送给MDS；</p></li><li><p>如果响应超时，或表示MDS暂时不可用，返回到步骤2进行重试；如果statusCode表示无效注册等含义，chunkserver退出</p></li><li><p>将chunkserverID和token持久化到盘上，注册完毕</p></li></ul><h5 class="anchor anchorWithStickyNavbar_LWe7" id="chunksever注册信息的持久化">chunksever注册信息的持久化：<a href="#chunksever注册信息的持久化" class="hash-link" aria-label="chunksever注册信息的持久化：的直接链接" title="chunksever注册信息的持久化：的直接链接">​</a></h5><p>chunkserver注册信息持久化的格式根据不同的存储引擎而不同，对于目前Ext4存储引擎, Chunkserver持久化信息保存在数据主目录下的chunkserver.dat文件中。
存储时，计算Chunkserver ID，token和数据版本号相关的checksum，构成ChunkserverPersistentData，以json的数据格式，写入到chunkserver.dat文件中。
读取时，获取的ChunkserverPersistentData数据首先校验校验码，防止读取到损坏的数据，并确认版本号是支持的版本。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="chunkserver-copyset重建">Chunkserver Copyset重建<a href="#chunkserver-copyset重建" class="hash-link" aria-label="Chunkserver Copyset重建的直接链接" title="Chunkserver Copyset重建的直接链接">​</a></h5><p>Chunkserver在重启时，需要重建在重启前已经分配过的Copyset，以响应来自Client/MDS端针对这些Copyset的访问。</p><p>由于Copyset被创建时和初始化时，会在数据主目录下创建copyset子目录，因而留下持久化信息，如1.4节所示。所以可以根据copyset目录列表，得到已经分配的Copyset列表；由于braft本身持久化了raft configuration，所以如果使用相同的copyset数据目录，braft可以自动从持久化信息中恢复出raft configuration。因此Copyset的持久化数据，可以全部从Chunkserver的本地存储盘获取。</p><p>Chunkserver启动时，通过扫描数据主目录下的&quot;LogicPoolId/CopysetId&quot;子目录列表，以获得Chunkserver已经创建的的Copyset列表，根据子目录名字的格式，可以解析出来poolId, 和copysetId，然后使用空的raft configuration可以重建Copyset实例，Copyset重建后，由于使用相同的raft各类数据目录，braft可以从snapshot meta中自动恢复出raft configuration出来，加载snapshot和log, 完成初始化。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="222-heartbeat">2.2.2 HeartBeat<a href="#222-heartbeat" class="hash-link" aria-label="2.2.2 HeartBeat的直接链接" title="2.2.2 HeartBeat的直接链接">​</a></h4><p>MDS需要实时的信息来确认Chunkserver的在线状态，并得到Chunkserver和Copyset的状态和统计数据，并根据信息下发相应的命令。
Chunkserver以心跳的方式来完成上述功能，通过周期性的心跳报文，更新Chunkserver和Copyset的信息，反馈上一个心跳周期的命令执行结果，并接受，解析和执行新的心跳响应报文。</p><p>Chunkserver通过心跳消息定期向MDS更新Chunkserver信息，Copyset状态信息，磁盘状态信息，配置变更命令执行状态等信息，MDS收到请求后，根据调度逻辑将新的copyset配置变更命令添加到消息响应中。</p><p>心跳流程详细流程图：</p><p><img loading="lazy" alt="heartbeat" src="/assets/images/chunkserver_heartbeat-3438df432f26b8f7c3692fa86b6bf6f1.png" width="1391" height="999" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="223-copysetnode">2.2.3 CopysetNode<a href="#223-copysetnode" class="hash-link" aria-label="2.2.3 CopysetNode的直接链接" title="2.2.3 CopysetNode的直接链接">​</a></h4><p>CopysetNode封装了RaftNode的状态机，是chunkserver的核心模块，其总体架构如下图所示：</p><p><img loading="lazy" alt="curve-raft-arch-1" src="/assets/images/curve-raft-arch-1-9abc006721b1853a6859a71c91bad4ab.png" width="1031" height="805" class="img_ev3q"></p><ul><li>Node Interface</li></ul><p>整个curve-raft对用户暴露的接口，主要提供给用户<code>Propose</code> task给raft statemachine处理</p><ul><li>raft层</li></ul><p>主要是核心处理逻辑的模块</p><p>（1）NodeImpl主要：</p><ol><li>接收来自外部的Request，然后通过 Raft statemachine <code>RawNode</code>的接口提交给状态机处理，而且其会拥有一个独立<code>Propose execqueue</code>负责驱动Raft statemachine运转，并输出中间结果<code>Ready</code></li><li>而且是<code>Node Interface</code>的实际实现者，除此之外，还包含了处理Tick timeout和InstallSnapshot的逻辑。</li></ol><p>（2）RaftNode</p><p>主要是处理Raft StateMachine的输出的中间结果<code>Ready</code>，包括异步处理<code>Ready</code>的exec queue。包含需要转发给其他Peers的Msg，需要落盘的Op log entries，以前需要Apply的committed entries</p><p>（3）FSMCaller</p><p>负责User StateMachine的具体执行逻辑，也就是State Machine Apply的逻辑，会包含相应的Apply bthread异步batch的处理需要Apply的请求。</p><ul><li>持久化&amp;网络接口</li></ul><p>（1）Snapshot Storage：负责snapshot meta和snapshot read/write接口</p><p>（2）LogManager：Op Log日志管理者，包含Op Log的读写接口，还有Log落盘的batch控制，Op Log缓存等。实际的Op Log最基本的读写接口还是依赖LogStorage的实现。</p><p>（3）Raft Meta Storage：raft meta（term,vote，也就是HardState）的持久化</p><p>（4）Transport：负责管理复制组Peers的连接，提供message send和peers链接管理的接口</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="224-chunkfilepool">2.2.4 ChunkFilePool<a href="#224-chunkfilepool" class="hash-link" aria-label="2.2.4 ChunkFilePool的直接链接" title="2.2.4 ChunkFilePool的直接链接">​</a></h4><p>ChunkFilePool位于DataStore层，Chunkserver使用基于ext4实现的本地文件系统，由于写操作存在较大的IO放大，因此在创建chunk文件时会调用fallocate为文件预分配固定大小的空间，但是即便fallocate以后，在写文件未写过的块时仍需要更改元数据，存在一定的IO放大。
curve使用的一种优化方案是直接使用覆盖写过一遍的文件。由于chunkserver上的所有chunk文件和快照文件都是相同固定大小的文件，所以可以预先生成一批被覆盖写过的固定大小文件，创建chunk文件或快照文件时直接从预分配的文件池中获取进行重命名，删除chunk文件或快照文件时再将文件重命名放到预分配池中，这个预分配池就是chunkfile-pool。</p><p>chunkserver目录结构：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">chunkserver/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    copyset_id/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                data/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                log/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                meta/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                snapshot/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chunkfilepool/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                chunkfile_xxx_tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                chunkfile_xxx_tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>系统初始化阶段：分配一定数量的chunk文件，这个预分配数量是可配置的，当系统重启的时候需要遍历chunkfilepool 目录，将还未分配出去的tmp chunk信息收集在对应的vector池子中，供后续查询使用。</li><li>GetChunk接口从chunkpool池子中取出一个闲置的chunk，如果池子里没有闲置的文件了，那么同步创建文件，如果池子的水位到达低水位，那么发起一个异步任务进行异步文件分配。</li><li>文件分配的操作基于的是文件系统的rename，rename操作可以保证原子性，因此保证了创建文件的原子性。</li><li>回收chunk：当外部删除chunk的时候，需要回收chunk，并将chunk置位。回收chunk避免了重新分配</li></ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/CurveBS/architecture/architecture-intro"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">架构介绍</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/CurveBS/architecture/client-arch"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">CurveBS Client 架构介绍</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-chunkserver-概述" class="table-of-contents__link toc-highlight">1 ChunkServer 概述</a><ul><li><a href="#11-设计背景" class="table-of-contents__link toc-highlight">1.1 设计背景</a></li><li><a href="#12-系统概述" class="table-of-contents__link toc-highlight">1.2 系统概述</a></li><li><a href="#13-设计目标" class="table-of-contents__link toc-highlight">1.3 设计目标</a></li></ul></li><li><a href="#2-chunk-server系统设计" class="table-of-contents__link toc-highlight">2 Chunk Server系统设计</a><ul><li><a href="#21-总体架构" class="table-of-contents__link toc-highlight">2.1 总体架构</a></li><li><a href="#22-关键模块" class="table-of-contents__link toc-highlight">2.2 关键模块</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">常用链接</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.opencurve.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">官网<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://ask.opencurve.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">论坛<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">联系我们</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.opencurve.io/WeChat" target="_blank" rel="noopener noreferrer" class="footer__link-item">微信<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://cloud-native.slack.com/archives/C03LFPT6BJM" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Curve Team. Documentation Distributed under CC-BY-4.0. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.a19401bb.js"></script>
<script src="/assets/js/main.3e776f2e.js"></script>
</body>
</html>