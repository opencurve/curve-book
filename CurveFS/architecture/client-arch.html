<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-CurveFS/architecture/client-arch">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">CurveFS Client 架构介绍 | Curve Book</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://docs.opencurve.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://docs.opencurve.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://docs.opencurve.io/CurveFS/architecture/client-arch"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="CurveFS Client 架构介绍 | Curve Book"><meta data-rh="true" name="description" content="1 概要"><meta data-rh="true" property="og:description" content="1 概要"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.opencurve.io/CurveFS/architecture/client-arch"><link data-rh="true" rel="alternate" href="https://docs.opencurve.io/CurveFS/architecture/client-arch" hreflang="zh"><link data-rh="true" rel="alternate" href="https://docs.opencurve.io/CurveFS/architecture/client-arch" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.ae228a11.css">
<link rel="preload" href="/assets/js/runtime~main.28ee2749.js" as="script">
<link rel="preload" href="/assets/js/main.d5d4b179.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="curve logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="curve logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Curve Book</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/opencurve/curve" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="搜索" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">关于 Curve</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/category/curve块存储">Curve块存储</a><button aria-label="打开/收起侧边栏菜单「Curve块存储」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/category/curve文件存储">Curve文件存储</a><button aria-label="打开/收起侧边栏菜单「Curve文件存储」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/category/应用场景及案例-1">应用场景及案例</a><button aria-label="打开/收起侧边栏菜单「应用场景及案例」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/category/部署-1">部署</a><button aria-label="打开/收起侧边栏菜单「部署」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/category/测试-1">测试</a><button aria-label="打开/收起侧边栏菜单「测试」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/category/同类软件对比-1">同类软件对比</a><button aria-label="打开/收起侧边栏菜单「同类软件对比」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/category/架构-1">架构</a><button aria-label="打开/收起侧边栏菜单「架构」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/CurveFS/architecture/architecture-intro">CurveFS 架构介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/CurveFS/architecture/client-arch">CurveFS Client 架构介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/CurveFS/architecture/metaserver-arch">CurveFS MetaServer 架构介绍</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/category/性能-1">性能</a><button aria-label="打开/收起侧边栏菜单「性能」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/category/运维-1">运维</a><button aria-label="打开/收起侧边栏菜单「运维」" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/category/开发者相关">开发者相关</a><button aria-label="打开/收起侧边栏菜单「开发者相关」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/category/社区相关">社区相关</a><button aria-label="打开/收起侧边栏菜单「社区相关」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/category/版本相关">版本相关</a><button aria-label="打开/收起侧边栏菜单「版本相关」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/faq">FAQ</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/category/roadmap">Roadmap</a><button aria-label="打开/收起侧边栏菜单「Roadmap」" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/category/curve文件存储"><span itemprop="name">Curve文件存储</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/category/架构-1"><span itemprop="name">架构</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">CurveFS Client 架构介绍</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>CurveFS Client 架构介绍</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-概要">1 概要<a href="#1-概要" class="hash-link" aria-label="1 概要的直接链接" title="1 概要的直接链接">​</a></h2><p>CurveFS client 作为CurveFS的客户端，使用rpc接口向后端的元数据集群和数据集群发送请求，调用后端相应接口，实现相应的功能。其通过对接fuse用户态文件系统接口，向上提供文件系统接口功能。CurveFS client支持数据存储在两种数据存储后端，分别是Curve块存储和S3兼容的对象存储，后续还可能支持CurveBS和S3混合存储，让数据根据冷热程度在CurveBS与S3之间流动。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-功能介绍">2 功能介绍<a href="#2-功能介绍" class="hash-link" aria-label="2 功能介绍的直接链接" title="2 功能介绍的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-提供标准posix文件系统接口">2.1 提供标准POSIX文件系统接口<a href="#21-提供标准posix文件系统接口" class="hash-link" aria-label="2.1 提供标准POSIX文件系统接口的直接链接" title="2.1 提供标准POSIX文件系统接口的直接链接">​</a></h3><p>CurveFS client通过对接libfuse 的 lowlevel fuse api，支持fuse用户态文件系统，实现标准POSIX文件系统接口。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-支持curvebs-后端存储引擎存储数据与缓存">2.2 支持CurveBS 后端存储引擎存储数据与缓存<a href="#22-支持curvebs-后端存储引擎存储数据与缓存" class="hash-link" aria-label="2.2 支持CurveBS 后端存储引擎存储数据与缓存的直接链接" title="2.2 支持CurveBS 后端存储引擎存储数据与缓存的直接链接">​</a></h3><p>CurveFS client 支持将文件系统数据，存储在CurveBS中。CurveBS提供的是块设备的接口，CurveFS client将文件系统数据组织成一定的结构，写入到CurveBS块设备中，从而实现CurveBS的后端数据存储。
CurveFS client支持将CurveBS中存储的数据缓存在内存中，以加速数据的读写性能。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="23-支持s3存储引擎存储数据与缓存">2.3 支持S3存储引擎存储数据与缓存<a href="#23-支持s3存储引擎存储数据与缓存" class="hash-link" aria-label="2.3 支持S3存储引擎存储数据与缓存的直接链接" title="2.3 支持S3存储引擎存储数据与缓存的直接链接">​</a></h3><p>CurveFS client 支持将文件系统数据，通过一定的格式，转换称为对象存储中的对象，并通过S3接口兼容的客户端（使用S3 C++ sdk）将文件数据保存在S3存储引擎中。
CurveFS client支持内存与磁盘缓存的二级的数据缓存，从而加速S3数据的读写性能。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="24-元数据获取和缓存">2.4 元数据获取和缓存<a href="#24-元数据获取和缓存" class="hash-link" aria-label="2.4 元数据获取和缓存的直接链接" title="2.4 元数据获取和缓存的直接链接">​</a></h3><p>CurveFS client 将文件系统元数据存储于CurveFS元数据集群，CurveFS client支持将元数据缓存在client端，从而提供更快速地元数据访问。其缓存的元数据信息有:</p><ul><li>文件系统全局信息，即FsInfo。</li><li>各文件和目录的元数据，包括dentry信息和inode信息两大部分。</li><li>各文件和目录的元数据的分布于的Copyset与Partition信息，CurveFS client缓存这些信息，从而向对应的Copyset与Partition请求元数据操作。</li><li>元数据集群的拓扑信息，CurveFS client需要知道元数据集群的ip、端口等拓扑信息，从而知道向哪个ip、端口发送rpc。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="25-元数据请求的异常处理和重试">2.5 元数据请求的异常处理和重试<a href="#25-元数据请求的异常处理和重试" class="hash-link" aria-label="2.5 元数据请求的异常处理和重试的直接链接" title="2.5 元数据请求的异常处理和重试的直接链接">​</a></h3><p>CurveFS mds 和 CurveFS metaserver集群，实现了高可用部署，其中</p><ul><li>CurveFS mds 同一时刻只有一个mds提供服务，其他mds节点通过etcd监听，当主mds发生异常时，备mds能够随时替代成为leader，此时需要CurveFS client寻找主mds和重试rpc请求以处理该种情况。</li><li>CurveFS metaserver集群，是以mutiraft集群的方式，对CurveFS client提供服务的，也会存在类似的leader切换等场景，此时也需要CurveFS client 去GetLeader以及在切换leader后重试rpc请求。</li></ul><p>除此之外，</p><ul><li>CurveFS client与上述组件的通信，也会因为网络繁忙等原因，造成rpc的超时等问题，那么同样需要CurveFS client 实现请求的重试。</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-架构">3 架构<a href="#3-架构" class="hash-link" aria-label="3 架构的直接链接" title="3 架构的直接链接">​</a></h2><p>CurveFS client包含几个主要模块：</p><p><img loading="lazy" alt="curvefs client structure" src="/assets/images/curvefs_client_structure-3178545e1036503e7a463701f3499340.png" width="692" height="342" class="img_ev3q"></p><ul><li>libfuse，对接了其lowlevel fuse api，支持fuse用户态文件系统；</li><li>元数据cache，包含fsinfo, inode cache, dentry cache, 实现对元数据的缓存；</li><li>meta rpc client， 主要对接元数据集群，实现meta op的发送，超时重试等功能；</li><li>S3 client， 通过对接S3接口，将数据存储在S3中；</li><li>S3 data cache， 这是S3数据存储的内存缓存层，作为数据缓存，加速S3数据的读写性能；</li><li>S3 disk cache，这是S3数据存储的本地持久化缓存，通过磁盘缓存，将对S3数据的读写暂时缓存在本地磁盘上，稍后在异步上传到S3，从而有效降低时延，提供吞吐；</li><li>curvebs client 通过对接Curve块存储SDK，实现将数据存储在Curve块存储集群中；</li><li>volume data cache，这是当数据存储在Curve块存储中的缓存层，以加速数据读写性能（开发中）；</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-io流程">4 IO流程<a href="#4-io流程" class="hash-link" aria-label="4 IO流程的直接链接" title="4 IO流程的直接链接">​</a></h2><p>CurveFS Client的IO流程分为两大部分，分别是元数据Meta IO流和数据Data IO流。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="41-meta-io-流">4.1 Meta IO 流<a href="#41-meta-io-流" class="hash-link" aria-label="4.1 Meta IO 流的直接链接" title="4.1 Meta IO 流的直接链接">​</a></h3><p><img loading="lazy" alt="meta flow" src="/assets/images/mknod_flow-8823a34502f5791949514446ce800a70.png" width="561" height="992" class="img_ev3q"></p><p>CurveFS 的元数据IO流，以MkNod为例，包含如下过程：</p><ul><li>用户调用文件系统MkNod接口，经过用户态文件系统fuse low level api，到达CurveFS client接口；</li><li>MkNod需要执行两步操作，分别是CreateInode和CreateDentry。CreateInode过程首先需要决定创建Inode的partition。通常情况下，topo信息和partition信息缓存在CurveFS client端，如果缓存中没有这些信息，那么CurveFS Client首先会去mds获取这些信息；</li><li>CurveFS client根据缓存中的partition信息，根据一定的策略，决定创建Inode的partiton；</li><li>根据缓存中或者获取到的topo信息以及partiton信息，找到需要创建Inode的copyset；</li><li>如果该copyset中缓存了leader信息，那么就可以直接发送CreateInode的rpc请求到对应的metaserver，否则，此时还需要向copyset中任一metaserver获取leader信息；</li><li>调用CreateInode的rpc创建完Inode后，接下来就要CreateDentry了；</li><li>同样的，Create Dentry过程，首先也需要根据一定的策略，决定创建Dentry的partiton；</li><li>之后，Create Dentry过程根据缓存中或者获取到的topo信息以及partiton信息，找到需要创建Dentry的copyset；</li><li>如果该copyset中缓存了leader信息，那么就可以直接发送CreateDentry的rpc请求到对应的metaserver，否则还需要向copyset中任一metaserver获取leader信息；</li><li>创建Dentry完成后，即完成了MkNod的功能。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="42-data-io-流">4.2 Data IO 流<a href="#42-data-io-流" class="hash-link" aria-label="4.2 Data IO 流的直接链接" title="4.2 Data IO 流的直接链接">​</a></h3><p>数据IO流分为两大部分，分别是数据存储到CurveBS的Data IO流与数据存储到S3的Data IO流，两者有少许区分，分别如下：</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="421-存储于curvebs-data-io流">4.2.1 存储于CurveBS Data IO流：<a href="#421-存储于curvebs-data-io流" class="hash-link" aria-label="4.2.1 存储于CurveBS Data IO流：的直接链接" title="4.2.1 存储于CurveBS Data IO流：的直接链接">​</a></h4><p><img loading="lazy" alt="curvebs dataio flow" src="/assets/images/curvebs_dataio_flow-44d29ddf5cf88f054e0fabfa8177412c.png" width="1011" height="1126" class="img_ev3q"></p><p>存储到CurveBS的Data IO流包含如下过程：</p><ul><li>用户调用文件系统write接口，经过用户态文件系统fuse low level api，到达CurveFS client接口；</li><li>CurveFS client 的write接口首先会获取Inode，如果Inode不在cache中，那么走类似上一节元数据的流程，从metaserver端获取Inode；</li><li>获取到Inode信息后，write接口首先会根据write的offset，len，判断是否需要分配新的空间；</li><li>如果需要分配新的空间，那么将调用AllocExtent RPC接口，向space server申请空间（以extent表示）；</li><li>分配到空间后，CurveFS client将调用CurveBS client的块设备接口，将数据写入CurveBS；</li><li>完成数据写入后，CurveFS client将数据写入信息和分配信息更新到Inode，并调用UpdateInode RPC，将Inode更新到metaserver。</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="422-存储与s3-data-io流">4.2.2 存储与S3 Data IO流：<a href="#422-存储与s3-data-io流" class="hash-link" aria-label="4.2.2 存储与S3 Data IO流：的直接链接" title="4.2.2 存储与S3 Data IO流：的直接链接">​</a></h4><p><img loading="lazy" alt="s3 dataio flow" src="/assets/images/s3_dataio_flow-93cc5d8d8eb9bbbaba20b0b7f723bdc1.png" width="761" height="1361" class="img_ev3q"></p><p>存储到S3的Data IO流包含如下过程：</p><ul><li>用户调用文件系统write接口，经过用户态文件系统fuse low level api，到达CurveFS client接口；</li><li>CurveFS client 的write接口会先将数据写入Data Cache中；</li><li>当DataCache数据满或者周期性的刷新时候到了的时候，CurveFS client将开始数据的Sync过程；</li><li>CurveFS client首先会将数据写入S3，（如果有disk cache，会先将数据写入disk cache，稍后再异步将数据写入S3）;</li><li>数据写入S3之后，CurveFS client会记录写入S3的数据的元信息，组织成S3ChunkInfo；</li><li>如果此时CurveFS client 没有缓存Inode信息，那么将会走前一节流程中的元数据流从metaserver获取Inode；</li><li>得到Inode后，CurveFS client会将S3ChunkInfo信息添加到Inode中；</li><li>完成本地Inode更新之后，CurveFS client 将会调用AppendS3ChunkInfo RPC接口增量更新metaserver端的Inode信息；</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-异常处理">5 异常处理<a href="#5-异常处理" class="hash-link" aria-label="5 异常处理的直接链接" title="5 异常处理的直接链接">​</a></h2><p>CurveFS client 的异常处理，主要指的是对元数据集群的各种异常，进行幂等的请求返回。主要涉及到对元数据集群mds和metaserver的rpc请求的重试，涉及包括如下功能：</p><ul><li>向mds节点请求的rpc，如果发现mds请求超时，那么需要重试，如果多次重试失败，那么可能切换了主mds，此时需要切换mds继续重试；</li><li>向metaserver的节点请求rpc，如果收到redirect的回复或者请求超时，则可能是因为切换了leader，此时需要重新获取leader，然后重试请求；</li></ul><p>上述重试过程还需要保证请求的幂等性，CurveFS Client对于请求的幂等性的保证，主要通过以下几种方式：</p><ul><li>对于删除类的请求，如果返回NOT EXIST错误，那么CurveFS Client会直接认为已经删除成功，从而幂等地执行成功。</li><li>对于向mds请求的，如Mount FS等请求，这些请求对于性能要求不高，CurveFS Client首先会通过Get FsInfo获取当前挂载点的情况，之后再去Mount FS。通过这种方式，保证Mount FS请求发送前没有被挂载，如果仍然返回了EXIST，那么可以肯定是rpc重试请求造成的，因此幂等的返回执行成功。</li><li>其他一些请求，如CreateDentry等，则根据CreateDentry请求内容中InodeId唯一性（重试的CreateDentry中请求的inodeId是一致的，非重试的请求InodeId一定不同）来区分是否是重试的请求，从而幂等的返回成功，或者返回EXIST错误。</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="6-关键设计">6 关键设计<a href="#6-关键设计" class="hash-link" aria-label="6 关键设计的直接链接" title="6 关键设计的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="61-rename">6.1 Rename<a href="#61-rename" class="hash-link" aria-label="6.1 Rename的直接链接" title="6.1 Rename的直接链接">​</a></h3><p>CurveFS 的rename 接口，为了保证原子性，借鉴了 leveldb 与 etcd(boltdb) 中事务的实现，设计如下图所示：</p><p><img loading="lazy" alt="rename" src="/assets/images/rename-dbfa8fd584154eb0ad6f9be24dd187e9.png" width="1331" height="747" class="img_ev3q"></p><ul><li>rename机制设计在 MDS 所有 copyset 中增加一个 txid 字段，保存当前 copyset 已成功的事务 id（该事务 id 顺序递增，事务每成功一次则加一）；</li><li>每次 rename 开始时，将 srcDentry, dstDentry 所在 copyset 对应的 txid 分别加 1 (copyset_txid+1) 去删除/创建/修改 dentry（其实就是创建副本，不管是删除/创建/更改都是创建相应 copyset_txid+1 为 key 的副本，原始 dentry 不动），并设置 PendingTx 为本次事务；</li><li>如果上一步骤成功了，就提交事务，将 srcDentry, dstDentry 所在 copyset 的 txid 都加 1（这一步是通过 etcd 的事务保证的），如果上一步或这一步失败，因为 txid 不变，原始数据版本也在，还是保证原子性（其实就是一个 txid 对应一个版本的数据）；</li><li>下次访问的时候，带上对应 copyset 的最新 txid (copyset_txid)，判断 PendingTx，如果 (copyset_txid &gt;= PendingTxId &amp;&amp; rpc_request.key == PendingTxKey)，则表明 PendingTx 对应的事务是已经成功了的，并且 PendingTx 对应事务刚好操作的是请求的 dentry，则返回 PendingTxKey + PendingTxId 对应的副本 dentry，否则返回原始 dentry；</li><li>PendingTx 与 dentry 副本是一一对应的，每个 copyset 只需要一个 PendingTx（即整个 copyset 中最多只会存留一个副本 dentry)；</li></ul><p>CurveFS client的rename机制通过在mds端向etcd原子的提交事务的方式，最终实现了整个Rename的原子性。</p><blockquote><p>对rename操作的进一步优化正在进行中，预计2.7版本发布。</p></blockquote></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/CurveFS/architecture/architecture-intro"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">CurveFS 架构介绍</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/CurveFS/architecture/metaserver-arch"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">CurveFS MetaServer 架构介绍</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-概要" class="table-of-contents__link toc-highlight">1 概要</a></li><li><a href="#2-功能介绍" class="table-of-contents__link toc-highlight">2 功能介绍</a><ul><li><a href="#21-提供标准posix文件系统接口" class="table-of-contents__link toc-highlight">2.1 提供标准POSIX文件系统接口</a></li><li><a href="#22-支持curvebs-后端存储引擎存储数据与缓存" class="table-of-contents__link toc-highlight">2.2 支持CurveBS 后端存储引擎存储数据与缓存</a></li><li><a href="#23-支持s3存储引擎存储数据与缓存" class="table-of-contents__link toc-highlight">2.3 支持S3存储引擎存储数据与缓存</a></li><li><a href="#24-元数据获取和缓存" class="table-of-contents__link toc-highlight">2.4 元数据获取和缓存</a></li><li><a href="#25-元数据请求的异常处理和重试" class="table-of-contents__link toc-highlight">2.5 元数据请求的异常处理和重试</a></li></ul></li><li><a href="#3-架构" class="table-of-contents__link toc-highlight">3 架构</a></li><li><a href="#4-io流程" class="table-of-contents__link toc-highlight">4 IO流程</a><ul><li><a href="#41-meta-io-流" class="table-of-contents__link toc-highlight">4.1 Meta IO 流</a></li><li><a href="#42-data-io-流" class="table-of-contents__link toc-highlight">4.2 Data IO 流</a></li></ul></li><li><a href="#5-异常处理" class="table-of-contents__link toc-highlight">5 异常处理</a></li><li><a href="#6-关键设计" class="table-of-contents__link toc-highlight">6 关键设计</a><ul><li><a href="#61-rename" class="table-of-contents__link toc-highlight">6.1 Rename</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">常用链接</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.opencurve.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">官网<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://ask.opencurve.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">论坛<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">联系我们</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.opencurve.io/WeChat" target="_blank" rel="noopener noreferrer" class="footer__link-item">微信<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://cloud-native.slack.com/archives/C03LFPT6BJM" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Curve Team. Documentation Distributed under CC-BY-4.0. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.28ee2749.js"></script>
<script src="/assets/js/main.d5d4b179.js"></script>
</body>
</html>